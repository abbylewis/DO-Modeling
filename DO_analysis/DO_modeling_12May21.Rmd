---
title: "DO Modeling"
author: "Abby Lewis"
date: "5/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(tidyverse)
library(zoo)
library(deSolve)
library(lubridate)
library(formatR)
library(knitr)
source('DO_modeling_functions_12May21.R')
source('O2_models_20Jan21.R')
library(magick)
library(rLakeAnalyzer)
library(animation)
library(Metrics)
library(DTWBI)
#library(verification) this messes with select from tidyverse!
```

Created 12 May 2021 to stop using enkf and convert to modeling framework

TO DO:
Add 2020 data
Model comparison: AIC?????
Add in Fe data as a measure of chemical oxygen demand
- Calculate total Fe mass using hypo volume
- Started this^^^ but it is just using the volume of each layer, missing the in between layers. Also should then be divided by total volume
Switch to Bayesian framework??

DONE:
Get existing code to run without EnKF
Plot predictions with data
Streamline code
Get rid of negative oxygen demand problem
Set up code for temp and o2-independent models
Get best parameters for full model
Get best parameters for o2 and temp models
Create predictions for the entire summer with no data
Create predictions for each data point from the last data point

#```{r}
#Create observations dataframe
vol <- read_csv("../DO_modeling_data/BVR Bathymetry.csv")
dt1 <- read.csv("../DO_modeling_data/CTD_final_2013_2020.csv")
dt1$Date <- as.POSIXct(dt1$Date)
dt1_culled <- dt1 %>%
  filter(Site == 50 & Reservoir == "BVR" & !is.na(DO_mgL))
depths <- vol$Depth_m
df.final2<-dt1_culled %>% group_by(Date) %>% slice(which.min(abs(as.numeric(Depth_m) - depths[1]))) #Create a new dataframe
df.final2$Depth_m <- depths[1]
for (j in 2:length(depths)){ #loop through all depths and add the closest values to the final dataframe
  ctd_atThisDepth <- dt1_culled %>% group_by(Date) %>% slice(which.min(abs(as.numeric(Depth_m) - depths[j])))
  ctd_atThisDepth$Depth_m <- depths[j]
  df.final2 <- rbind(df.final2,ctd_atThisDepth)
}
thermo <- df.final2 %>%
  group_by(Date) %>%
  summarize(meta_bottom = meta.depths(Temp_C, Depth_m)[2])
vw <- df.final2 %>%
  filter(as.Date(Date)!=as.Date("2017-07-06")) %>%
  group_by(Date) %>%
  left_join(thermo, by = "Date") %>%
  mutate(Thermocline = meta_bottom) %>% 
  ungroup() %>%
  left_join(vol, by = "Depth_m")%>%
  mutate(DO_Weighted = DO_mgL*Volume_L,
         TP_Weighted = Temp_C*Volume_L) %>%
  filter(Depth_m >= Thermocline,) %>%
  group_by(Date) %>%
  summarize(
    thermo_depth = unique(Thermocline),
    Vol_Weighted_DO = sum(DO_Weighted),
    hypoVolume = sum(Volume_L),
    Conc = Vol_Weighted_DO/hypoVolume,
    Temp = sum(TP_Weighted)/hypoVolume,
    Temp_sed = last(Temp_C),
    Chla_ugL = mean(Chla_ugL),
    SA_m2 = mean(SA_m2))
write.csv(vw, "../DO_modeling_data/vol_weighted_do_bvr_2013_2020.csv")
#```

```{r}
CTD <- read.csv("../DO_modeling_data/vol_weighted_do_fcr_2013_2020.csv")
CTD = CTD%>%
  filter(hypoVolume>0,
         !is.na(Conc))%>%
  mutate(Date = as.Date(Date))
obs <- CTD %>%
  filter(!is.na(Conc))%>%
  dplyr::select(Date, Conc)%>%
  rename(datetime = Date)%>%
  group_by(datetime)%>%
  summarize(O2_mgL = mean(Conc))
metals <- read.csv("../DO_modeling_data/metals_EDI_current.csv")%>%
  filter(Reservoir == "FCR",
         Site == 50)%>%
  mutate(DateTime = as.POSIXct(DateTime, format = "%m/%d/%Y %H:%M:%S"))
vol <- read_csv("../DO_modeling_data/FCR Bathymetry.csv")
Depth_m = c(6.2,8,9)
Volume_L = c(sum(vol$Volume_L[vol$Depth_m>=6.2&vol$Depth_m<8]),sum(vol$Volume_L[vol$Depth_m>=8&vol$Depth_m<9]),sum(vol$Volume_L[vol$Depth_m>=9]))
vol = tibble(Depth_m,Volume_L)
hypo_vol = sum(vol$Volume_L)
metals_vw = metals%>%
  filter(Depth_m>5)%>%
  left_join(vol)%>%
  mutate(Fe_g = TFe_mgL * Volume_L)%>%
  group_by(DateTime)%>%
  summarize(total_Fe_g = sum(Fe_g)/hypo_vol)%>%
  mutate(Date = as.Date(DateTime))%>%
  group_by(Date)%>%
  summarize(total_Fe_g = mean(total_Fe_g))

mean_hypo_ratio <- mean(CTD$SA_m2/CTD$hypoVolume)
median_hypo_ratio <- median(CTD$SA_m2/CTD$hypoVolume)

SSS <- read_excel("../DO_modeling_data/Calc_HOX_flow_DO_20190320.xlsx") 
SSS$time <- as.Date(SSS$time)

### SSS ADJUSTMENT
SSS[year(SSS$time)==2019,"scfm"]<- .8*SSS[year(SSS$time)==2019,"scfm"]
SSS[year(SSS$time)==2020,"scfm"]<- .8*SSS[year(SSS$time)==2020,"scfm"]
  
start_stop <- read.csv("../DO_modeling_data/start_stop.csv")
start_all = as.Date(start_stop$start_all)
stop_all = as.Date(start_stop$stop_all)
avgs <- calc_avg(start_all,stop_all,CTD,SSS)
avg_temp<-unlist(avgs[1])
avg_o2<-unlist(avgs[2])
avg_hypoVolume<-unlist(avgs[3])
CTD$hypoVolume<-avg_hypoVolume

temp_slope = 0.03937878

```


```{r}
palette_6 = c("#006d77ff", "#83c5beff", "#e29578ff", "#922d50ff", "darkorchid1", "maroon1","seagreen3")

jpeg("../DO_modeling_figures/temp_o2_disentangle.jpeg", res = 600, width = 6, height = 4, units = "in")
CTD%>%
  mutate(Year = year(Date))%>%
  left_join(start_stop%>%mutate(Year = year(stop_all)), by="Year")%>%
  filter(Date>=start_all, Date<=stop_all, Year!=2017)%>%
  ggplot(aes(x = Temp, y = Conc, color = as.factor(Year)))+
  geom_point()+
  scale_color_manual(values = palette_6)+
  xlab("Temperature (ºC)")+
  ylab("Hypolimnetic oxygen (mg/L)")+
  labs(color = "Year")+
  theme_bw()
dev.off()


bvr <- read.csv("../DO_modeling_data/vol_weighted_do_bvr_2013_2020.csv")
bvr = bvr%>%
  filter(hypoVolume>0,
         !is.na(Conc))%>%
  mutate(Date = as.Date(Date))
jpeg("../DO_modeling_figures/temp_o2_disentangle_bvr.jpeg", res = 600, width = 6, height = 4, units = "in")
bvr%>%
  mutate(Year = year(Date))%>%
  #left_join(start_stop%>%mutate(Year = year(stop_all)), by="Year")%>%
  #filter(Date>=start_all, Date<=stop_all, Year!=2017)%>%
  filter(Year == 2018)%>%
  ggplot(aes(x = Temp, y = Conc, color = as.factor(Year)))+
  geom_point()+
  xlab("Temperature (ºC)")+
  ylab("Hypolimnetic oxygen (mg/L)")+
  labs(color = "Year")+
  theme_bw()
dev.off()

SSS%>%mutate(year = year(time))%>%filter(year==2018)
```


Running model and recording oxygen demand
```{r}
off_starts = SSS%>%
  arrange(time)%>%
  filter(lead(scfm == 0), scfm != 0)
off_starts$time[off_starts$time==as.Date("2018-08-12")]<-as.Date("2018-08-14")
off_starts$time[off_starts$time==as.Date("2019-07-19")]<-as.Date("2019-07-18")
obs = obs%>%
  filter(datetime %in% off_starts$time)
off_ends = SSS%>%
  arrange(time)%>%
  filter(lag(scfm == 0), scfm != 0)

restart = T
realDrivers = T
model_name = "full" #full, o2, temp, sss
if(model_name == "full"){
  model = O2_model
  parms = c(0.8315, 1.0200, 4, 1.6089)
  #0.5754   parms2:    +1.0200   parms3:    +4.0000   parms4:    +2.3322, y =    +2.5291
  }
if(model_name == "temp"){
  model = temp_model
  parms = c(0.7019, 1.0613, 1.6972)}
if(model_name == "o2"){
  model = no_temp_model
  parms = c(0.4216, 4.0000, 2.9012)}
if(model_name == "sss"){
  model = sss_model
  parms = c(0.3003, 2.5570)}

inc_metals = F

#2013 (maybe can't do 2013--no iron data. Set inc_metals to F)
start = start_all[year(start_all)==2013]
stop = stop_all[year(stop_all)==2013]
inputs_2013 <- format_model_inputs(start,stop,CTD,SSS,obs,metals_vw,today = stop, realDrivers = realDrivers, model_name = model_name, inc_metals = inc_metals)
test_2013 <- predict_no_enkf(start,stop,obs,drivers = inputs_2013,parms = parms, model = model, restart = restart, inc_metals = inc_metals)
no_csss <- parms[1] * parms[2]^(test_2013$drivers[,2]-20)*test_2013$Y/(test_2013$Y+parms[3])
demand <- no_csss
temp <- parms[2]^(test_2013$drivers[,2]-20)
o2 <- test_2013$Y/(test_2013$Y+parms[3])
r20 <- parms[1]
for(i in 1:length(no_csss)){
  if(test_2013$drivers[i,1] > 0){
    demand[i] = demand[i]*parms[4]
  }
}
demand_all = tibble(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
demand_all$year = 2013

#2014
start = start_all[year(start_all)==2014]
stop = stop_all[year(stop_all)==2014]
inputs_2014 <- format_model_inputs(start,stop,CTD,SSS,obs,metals_vw, today = stop, realDrivers = realDrivers, model_name = model_name, inc_metals = inc_metals)
test_2014 <- predict_no_enkf(start,stop,obs,drivers = inputs_2014,parms = parms, model = model, restart = restart, inc_metals = inc_metals)
no_csss <- parms[1] * parms[2]^(test_2014$drivers[,2]-20)*test_2014$Y/(test_2014$Y+parms[3])
demand <- no_csss
temp <- parms[2]^(test_2014$drivers[,2]-20)
o2 <- test_2014$Y/(test_2014$Y+parms[3])
r20 <- parms[1]
for(i in 1:length(no_csss)){
  if(test_2014$drivers[i,1] > 0){
    demand[i] = demand[i]*parms[4]
  }
}
#demand_all = tibble(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
#demand_all$year = 2014
demand_all_2014 = data_frame(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
demand_all_2014$year = 2014
demand_all = demand_all%>%
  full_join(demand_all_2014)

##2015
#start = start_all[year(start_all)==2015]
#stop = stop_all[year(stop_all)==2015]
#inputs_2015 <- format_model_inputs(start,stop,CTD,SSS,obs,metals_vw,today = stop, realDrivers = realDrivers, model_name = model_name, inc_metals = inc_metals)
#test_2015 <- predict_no_enkf(start,stop,obs,drivers = inputs_2015,parms = parms, model = model, restart = restart, inc_metals = inc_metals)
#no_csss <- parms[1] * parms[2]^(test_2015$drivers[,2]-20)*test_2015$Y/(test_2015$Y+parms[3])
#demand <- no_csss
#temp <- parms[2]^(test_2015$drivers[,2]-20)
#o2 <- test_2015$Y/(test_2015$Y+parms[3])
#r20 <- parms[1]
#for(i in 1:length(no_csss)){
#  if(test_2015$drivers[i,1] > 0){
#    demand[i] = demand[i]*parms[4]
#  }
#}
#demand_all_2015 = data_frame(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
#demand_all_2015$year = 2015
#demand_all = demand_all%>%
#  full_join(demand_all_2015)
#
##2016
#start = start_all[year(start_all)==2016]
#stop = stop_all[year(stop_all)==2016]
#inputs_2016 <- format_model_inputs(start,stop,CTD,SSS,obs,metals_vw,today = stop, realDrivers = realDrivers, model_name = model_name, inc_metals = inc_metals)
#test_2016 <- predict_no_enkf(start,stop,obs,drivers = inputs_2016,parms = parms, model = model, restart = restart, inc_metals = inc_metals)
#no_csss <- parms[1] * parms[2]^(test_2016$drivers[,2]-20)*test_2016$Y/(test_2016$Y+parms[3])
#demand <- no_csss
#temp <- parms[2]^(test_2016$drivers[,2]-20)
#o2 <- test_2016$Y/(test_2016$Y+parms[3])
#r20 <- parms[1]
#for(i in 1:length(no_csss)){
#  if(test_2016$drivers[i,1] > 0){
#    demand[i] = demand[i]*parms[4]
#  }
#}
#demand_all_2016 = data_frame(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
#demand_all_2016$year = 2016
#demand_all = demand_all%>%
#  full_join(demand_all_2016)
#
##2017
#start = start_all[year(start_all)==2017]
#stop = stop_all[year(stop_all)==2017]
#inputs_2017 <- format_model_inputs(start,stop,CTD,SSS,obs,metals_vw,today = stop, realDrivers = realDrivers, model_name = model_name, inc_metals = inc_metals)
#test_2017 <- predict_no_enkf(start,stop,obs,drivers = inputs_2017,parms = parms, model = model, restart = restart, inc_metals = inc_metals)
#no_csss <- parms[1] * parms[2]^(test_2017$drivers[,2]-20)*test_2017$Y/(test_2017$Y+parms[3])
#demand <- no_csss
#temp <- parms[2]^(test_2017$drivers[,2]-20)
#o2 <- test_2017$Y/(test_2017$Y+parms[3])
#r20 <- parms[1]
#for(i in 1:length(no_csss)){
#  if(test_2017$drivers[i,1] > 0){
#    demand[i] = demand[i]*parms[4]
#  }
#}
#demand_all_2017 = data_frame(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
#demand_all_2017$year = 2017
#demand_all = demand_all%>%
#  full_join(demand_all_2017)
#
#2018
start = start_all[year(start_all)==2018]
stop = stop_all[year(stop_all)==2018]
inputs_2018 <- format_model_inputs(start,stop,CTD,SSS,obs,metals_vw,today = stop, realDrivers = realDrivers, model_name = model_name, inc_metals = inc_metals)
test_2018 <- predict_no_enkf(start,stop,obs,drivers = inputs_2018,parms = parms, model = model, restart = restart, inc_metals = inc_metals)
no_csss <- parms[1] * parms[2]^(test_2018$drivers[,2]-20)*test_2018$Y/(test_2018$Y+parms[3])
demand <- no_csss
temp <- parms[2]^(test_2018$drivers[,2]-20)
o2 <- test_2018$Y/(test_2018$Y+parms[3])
r20 <- parms[1]
for(i in 1:length(no_csss)){
  if(test_2018$drivers[i,1] > 0){
    demand[i] = demand[i]*parms[4]
  }
}
demand_all_2018 = data_frame(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
demand_all_2018$year = 2018
demand_all = demand_all%>%
  full_join(demand_all_2018)

#2019
start = start_all[year(start_all)==2019]
stop = stop_all[year(stop_all)==2019]
inputs_2019 <- format_model_inputs(start,stop,CTD,SSS,obs,metals_vw,today = stop, realDrivers = realDrivers, model_name = model_name, inc_metals = inc_metals)
test_2019 <- predict_no_enkf(start,stop,obs,drivers = inputs_2019,parms = parms, model = model, restart = restart, inc_metals = inc_metals)
no_csss <- parms[1] * parms[2]^(test_2019$drivers[,2]-20)*test_2019$Y/(test_2019$Y+parms[3])
demand <- no_csss
temp <- parms[2]^(test_2019$drivers[,2]-20)
o2 <- test_2019$Y/(test_2019$Y+parms[3])
r20 <- parms[1]
for(i in 1:length(no_csss)){
  if(test_2019$drivers[i,1] > 0){
    demand[i] = demand[i]*parms[4]
  }
}
demand_all_2019 = data_frame(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
demand_all_2019$year = 2019
demand_all = demand_all%>%
  full_join(demand_all_2019)

#2020
start = start_all[year(start_all)==2020]
stop = stop_all[year(stop_all)==2020]
inputs_2020 <- format_model_inputs(start,stop,CTD,SSS,obs,metals_vw,today = stop, realDrivers = realDrivers, model_name = model_name, inc_metals = inc_metals)
test_2020 <- predict_no_enkf(start,stop,obs,drivers = inputs_2020,parms = parms, model = model, restart = restart, inc_metals = inc_metals)
no_csss <- parms[1] * parms[2]^(test_2020$drivers[,2]-20)*test_2020$Y/(test_2020$Y+parms[3])
demand <- no_csss
temp <- parms[2]^(test_2020$drivers[,2]-20)
o2 <- test_2020$Y/(test_2020$Y+parms[3])
r20 <- parms[1]
for(i in 1:length(no_csss)){
  if(test_2020$drivers[i,1] > 0){
    demand[i] = demand[i]*parms[4]
  }
}
demand_all_2020 = data_frame(no_csss, demand, temp, o2, r20, dsim = 1:length(no_csss))
demand_all_2020$year = 2020
demand_all = demand_all%>%
  full_join(demand_all_2020)

start = data.frame(start_all)
start$year = year(start$start)
demand_all_final <- demand_all%>%
  left_join(start, by = "year")%>%
  mutate(Calendar_date = start_all+dsim-1,
         doy = strftime(Calendar_date, format = "%j"))%>%
  dplyr::select(-start_all)
demand_all_final$sss_on <- 0
demand_all_final$sss_on[demand_all_final$no_csss_mean != demand_all_final$demand_mean]<- 1

demand_all_long = demand_all_final%>%
  pivot_longer(cols = c("no_csss","demand","temp","o2","r20"), names_to = "type", values_to = "mean")

palette_6 <- c("#006d77ff", "#83c5beff", "#e29578ff", "#922d50ff", "#542966", "#231B20")
jpeg("../DO_modeling_figures/demand.jpg",width = 7, height = 4, res = 300, units = "in")
demand_all_long%>%
  filter(type %in% c("no_csss","demand"))%>%
  ggplot(aes(x = Calendar_date, y = mean))+
  geom_tile(aes(fill = as.factor(sss_on), alpha = as.factor(sss_on)), height = Inf, show.legend = F)+
  geom_line(aes(color = type))+
  facet_wrap(~year, scales = "free_x")+
  theme_bw()+
  ylab(expression(paste("Oxygen demand (g ",m^-3, " ",d^-1," )")))+
  xlab("")+
  scale_color_manual(labels = c("Total oxygen demand","HOx-independent component of oxygen demand"), 
                     name = "", values = palette_6[c(1,3)])+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = c("white","grey20"))+
  scale_alpha_manual(values = c(0,.1))
dev.off()

demand_all_long$AHOD = demand_all_long$mean*22233192/15000/1000 #times hypo volume (L) divided by approximate area at 5.5 meters (m2), converted from mg to grams

demand_all_long%>%
  filter(type %in% c("no_csss","demand"))%>%
  ggplot(aes(x = Calendar_date, y = AHOD))+
  geom_tile(aes(fill = as.factor(sss_on), alpha = as.factor(sss_on)), height = Inf, show.legend = F)+
  geom_line(aes(color = type))+
  facet_wrap(~year, scales = "free_x")+
  theme_bw()+
  ylab(expression(paste("Areal hypolimnetic oxygen demand (g ",m^-2, " ",d^-1," )")))+
  xlab("")+
  scale_color_discrete(labels = c("Total oxygen demand","HOx-independent component of oxygen demand"), name = "")+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = c("white","grey20"))+
  scale_alpha_manual(values = c(0,.1))


demand_all_long%>%
  group_by(type)%>%
  summarise_all(max)

jpeg("../DO_modeling_figures/demand_components.jpg",width = 7, height = 4, res = 300, units = "in")
demand_all_long%>%
  filter(!type %in%c("demand","no_csss"))%>%
  ggplot(aes(x = Calendar_date, y = mean))+
  geom_line(aes(color = type))+
  facet_wrap(~year, scales = "free_x")+
  theme_bw()+
  ylab("value")+
  scale_color_manual(limits = c("r20","temp","o2"),labels = c("R20","Temperature multiplier","Oxygen multiplier"), name = "", values = palette_6[c(1,2,3)])+
  theme(legend.position = "bottom")+
  xlab("")
dev.off()

oxygen = data.frame(oxy = test_2013$Y, dsim = 1:length(test_2013$Y), year = 2013)%>%
  full_join(data.frame(oxy = test_2014$Y, dsim = 1:length(test_2014$Y), year = 2014))%>%
  full_join(data.frame(oxy = test_2015$Y, dsim = 1:length(test_2015$Y), year = 2015))%>%
  full_join(data.frame(oxy = test_2016$Y, dsim = 1:length(test_2016$Y), year = 2016))%>%
  full_join(data.frame(oxy = test_2017$Y, dsim = 1:length(test_2017$Y), year = 2017))%>%
  full_join(data.frame(oxy = test_2018$Y, dsim = 1:length(test_2018$Y), year = 2018))%>%
  full_join(data.frame(oxy = test_2019$Y, dsim = 1:length(test_2019$Y), year = 2019))%>%
  full_join(data.frame(oxy = test_2020$Y, dsim = 1:length(test_2020$Y), year = 2020))%>%
  left_join(start, by = "year")%>%
  mutate(Calendar_date = start_all+dsim-1,
         doy = strftime(Calendar_date, format = "%j"))%>%
  dplyr::select(-start_all)

oxygen%>%
  ggplot(aes(x = Calendar_date, y = oxy))+
  geom_line()+
  facet_wrap(~year, scales = "free_x")+
  theme_bw()+
  geom_point(aes(x = datetime, y = O2_mgL), data = obs%>% mutate(year = year(datetime)))

write.csv(oxygen,paste0("predictions_",model_name,"_restart_",restart,".csv"))
```


```{r}
full = read.csv("predictions_full.csv")
temp = read.csv("predictions_temp.csv")
o2 = read.csv("predictions_o2.csv")
sss = read.csv("predictions_sss.csv")

all = full%>%
  mutate(model = "full")%>%
  full_join(temp%>%mutate(model = "temp"))%>%
  full_join(o2%>%mutate(model = "o2"))%>%
  #full_join(sss%>%mutate(model = "sss"))%>% #leaving this out for presentation because it does really well....
  mutate(Calendar_date=as.Date(Calendar_date))%>%
  mutate(model = as.factor(model))

obs_plot =obs%>%
  mutate(year = year(datetime))%>%
  left_join(start_stop%>% mutate(year = year(start_all)), by = "year")%>%
  filter(datetime>=start_all,
         datetime<=stop_all)%>%
  select(-start_all,-stop_all,-X)

palette <- c("#e29578ff","#006d77ff", "grey20")

jpeg("timeseries_all_models.jpg", width = 8, height = 3, units = "in", res = 300)
all%>%
  filter(year!=2017)%>%
  ggplot(aes(x = Calendar_date, y = oxy))+
  geom_line(aes(color = model))+
  xlab("")+
  ylab("Oxygen (mg/L)")+
  scale_color_manual(limits = c("temp","o2", "full"), 
                     labels = c("temperature-only","oxygen-only", "full model"),
                     values = palette)+
  facet_wrap(~year, scales = "free_x", nrow = 2)+
  theme_bw()+
  geom_point(aes(x = datetime, y = O2_mgL), data = obs_plot%>%filter(year!=2017))+
  theme_bw()
dev.off()

colnames(obs_plot)
colnames(all)

resids = all%>%
  select(-X, -doy, -dsim)%>%
  rename(O2_mgL_model = oxy,
         datetime = Calendar_date)%>%
  left_join(obs_plot)%>%
  filter(!is.na(O2_mgL))%>%
  mutate(resids = O2_mgL_model-O2_mgL)

resids%>%
  filter(year != 2017)%>%
  ggplot(aes(x = model, y = resids))+
  geom_boxplot()+
  facet_wrap(~year)

resids%>%
  filter(year != 2017)%>%
  ggplot(aes(x = model, y = resids))+
  geom_boxplot()

rmse = resids%>%
  group_by(model, year)%>%
  summarize(rmse = rmse(O2_mgL,O2_mgL_model))
rmse$type = "Training"
rmse$type[rmse$year%in%c(2018,2019,2020)]<-"Test"
rmse$type<-factor(rmse$type, levels = c("Training", "Test"))


palette_6 = c("#006d77ff", "#83c5beff", "#e29578ff", "#922d50ff", "darkorchid1", "maroon1","seagreen3")

jpeg("rmse.jpeg",res = 600, height = 3, width = 6, units = "in")
rmse%>%
  filter(year!=2017)%>%
  ggplot(aes(x = model, y = rmse, color = as.factor(year)))+
  geom_point()+
  facet_wrap(~type)+
  scale_x_discrete(limits = c("temp","o2", "full"), labels = c("temperature","oxygen", "full"))+
  ylab("RMSE")+
  scale_color_manual(values = palette_6)+
  labs(color = "Year")+
  theme_bw()
dev.off()

resids%>%
  filter(model == "temp")%>%
  ggplot(aes(x = O2_mgL, y = resids))+
  geom_point()
```


```{r}
full = read.csv("predictions_full_restart_TRUE.csv")
temp = read.csv("predictions_temp_restart_TRUE.csv")
o2 = read.csv("predictions_o2_restart_TRUE.csv")

all = full%>%
  mutate(model = "full")%>%
  full_join(temp%>%mutate(model = "temp"))%>%
  full_join(o2%>%mutate(model = "o2"))%>%
  #full_join(sss%>%mutate(model = "sss"))%>% #leaving this out for presentation because it does really well....
  mutate(Calendar_date=as.Date(Calendar_date))%>%
  mutate(model = as.factor(model))


obs <- CTD %>%
  filter(!is.na(Conc))%>%
  dplyr::select(Date, Conc)%>%
  rename(datetime = Date)%>%
  group_by(datetime)%>%
  summarize(O2_mgL = mean(Conc))

obs_plot =obs%>%
  mutate(year = year(datetime))%>%
  left_join(start_stop%>% mutate(year = year(start_all)), by = "year")%>%
  filter(datetime>=start_all,
         datetime<=stop_all)%>%
  select(-start_all,-stop_all,-X)

all%>%
  filter(year%in%c(2018,2019,2020))%>%
  ggplot(aes(x = Calendar_date, y = oxy))+
  geom_line(aes(color = model))+
  xlab("")+
  ylab("Oxygen (mg/L)")+
  facet_wrap(~year, scales = "free_x", nrow = 2)+
  theme_bw()+
  geom_point(aes(x = datetime, y = O2_mgL), data = obs_plot%>%filter(year%in%c(2018,2019,2020)))+
  theme_bw()

off_intervals = data.frame(start = off_starts$time,end = c(off_ends$time,as.Date("2020-12-31")), year = year(off_starts$time), int_num = seq(1:22))
off_intervals$end[off_intervals$end == as.Date("2019-04-30")]<-"2018-09-01"

obs_plot =obs%>%
  mutate(year = year(datetime))%>%
  left_join(start_stop%>% mutate(year = year(start_all)), by = "year")%>%
  filter(datetime>=start_all,
         datetime<=stop_all)%>%
  left_join(off_intervals)%>%
  filter(datetime>=start, datetime<=end)%>%
  filter(year%in%c(2018,2019,2020))%>%
  select(-start_all,-stop_all,-X)%>%
  filter(int_num != 16)
obs_plot$int_num = paste0(obs_plot$start," to ",obs_plot$end)
  
all2 = all%>%
  left_join(off_intervals)%>%
  filter(Calendar_date>=start, Calendar_date<=end,
         year%in%c(2018,2019,2020),
         int_num !=16)

all2$int_num = paste0(all2$start," to ",all2$end)
all2$oxy[all2$Calendar_date<=all2$start]<- NA

int_names = c("2018","2018","2019","2019","2019","2020")
names(int_names) = unique(all2$int_num)

palette <- c("#e29578ff","#006d77ff", "grey20")

jpeg("timeseries_off_periods.jpg", width = 8, height = 3, units = "in", res = 300)
all2%>%
  ggplot(aes(x = Calendar_date, y = oxy))+
  geom_line(aes(color = model))+
  xlab("")+
  ylab("Oxygen (mg/L)")+
  facet_grid(~int_num, scales = "free_x", space = "free_x", labeller = labeller(int_num = int_names))+
  geom_point(aes(x = datetime, y = O2_mgL), data = obs_plot)+
  scale_color_manual(limits = c("temp","o2", "full"), 
                     labels = c("temperature-only","oxygen-only", "full model"),
                     values = palette)+
  theme_bw()+
  scale_x_date(date_breaks = "2 weeks", date_labels = "%e %b", minor_breaks = "1 week")+
  labs(color = "Model")
dev.off()
```






OLD CODE

Run forecasts!
```{r}
run_space <- 1 #Number of days between runs of the model
n_days <- 14 #Forecast horizon
gif = T
archiveForecasts = T
date <- format(Sys.Date(),"%d%b%y")
realDrivers = F
    

for(model_name in c("o2")){ #full,"temp","o2"
  
  if(model_name == "full"){
      ## Parameters
      parms <- c(
        R20=0.4419,
        theta = 1.0711,
        ko2 = 1.6725,
        sss_scalar = 3.5536)
      
      n_en = 100 # number of ensembles 
      # coefficient of variation (CV) as a representation of uncertainty 
      param_cv = c(R20 = .3,
                   theta = .005,
                   ko2 = .3,
                   sss_scalar = .2)
      driver_cv = c(SSS = .2,
                    temp = .04,#Calculated in a code chunk in the Poster_figures_17Jul20.Rmd file
                    o2_mgL = 0) # Coefficient of variation of driver data 
      init_cond_cv = 0.05
      proc_sd <- 0.2 #I am working on these calculations in a chunk below but not sure where to go
      obs_cv = 0.05
    }
    
    if(model_name == "temp"){
      ## Parameters
      parms <- c(
        R20=0.4419,
        theta = 1.0711,
        sss_scalar = 3.5536)
      
      n_en = 100 # number of ensembles 
      # coefficient of variation (CV) as a representation of uncertainty 
      param_cv = c(R20 = .3,
                   theta = .005,
                   sss_scalar = .2)
      driver_cv = c(SSS = .2,# Coefficient of variation of driver data 
                    temp = .04)#Calculated in a code chunk in the Poster_figures_17Jul20.Rmd file 
      init_cond_cv = 0.05
      proc_sd <- 0.2 
      obs_cv = 0.05
    }
    
    if(model_name == "o2"){
      ## Parameters
      parms <- c(
        R20=0.4419,
        ko2 = 1.6725,
        sss_scalar = 3.5536)
      
      n_en = 100 # number of ensembles 
      # coefficient of variation (CV) as a representation of uncertainty 
      param_cv = c(R20 = .3,
                   ko2 = .3,
                   sss_scalar = .2)
      driver_cv = c(SSS = .2) # Coefficient of variation of driver data 
      init_cond_cv = 0.05
      proc_sd <- 0.2 
      obs_cv = 0.05
    }
  
  for(uncert in c("all")){ #,"param","init","proc","driver"
    
    #if(uncert == "all"){
    #  gif = T
    #  archiveForecasts = T}
    
    
    
    #2013
    start = start_all[year(start_all)==2013]
    stop = stop_all[year(stop_all)==2013]
    results_2013 <- runForecasts(start, stop, n_days, run_space, obs, delay = 5, model_name = model_name, gif = gif,avg_o2 = avg_o2,avg_temp=avg_temp,uncert = uncert, archiveForecasts = archiveForecasts, parms = parms, realDrivers = realDrivers)
    dir.create(paste("../DO_modeling_results/",date,sep = ""))
    write.csv(results_2013,paste("../DO_modeling_results/",date,"/forecast_2013_",model_name,"_model_",uncert,"_uncert.csv", sep = ""))
    #rmse_2013_filt <- createRmseDF_filt(n_days, results_2013, obs, cali = 14/run_space) # Calculate rmse for days where there was an observation
    #rmse_2013 <- createRmseDF(n_days, results_2013, cali = 14/run_space) # Calculate rmse for all days
    #mean(rmse_2013$val, na.rm = T)
    #rmse_2013
    #calcRmseTotal(n_days, results_2013, cali = 14/run_space)
    #rmse_2013_filt
    
    #2014
    start = start_all[year(start_all)==2014]
    stop = stop_all[year(stop_all)==2014]
    results_2014 <- runForecasts(start, stop, n_days, run_space, obs, delay = 5, model_name = model_name, gif = gif,avg_o2 = avg_o2,avg_temp=avg_temp,uncert = uncert,archiveForecasts = archiveForecasts, parms = parms, realDrivers = realDrivers)
    write.csv(results_2014,paste("../DO_modeling_results/",date,"/forecast_2014_",model_name,"_model_",uncert,"_uncert.csv", sep = ""))
    #rmse_2014_filt <- createRmseDF_filt(n_days, results_2014, obs, cali = 14/run_space) # Calculate rmse for days where there was an observation
    #rmse_2014 <- createRmseDF(n_days, results_2014, cali = 14/run_space) # Calculate rmse for all days
    #rmse_2014
    #calcRmseTotal(n_days, results_2014, cali = 14/run_space)
    #rmse_2014_filt
    
    #2015
    start = start_all[year(start_all)==2015]
    stop = stop_all[year(stop_all)==2015]
    results_2015 <- runForecasts(start, stop, n_days, run_space, obs, delay = 5, model_name = model_name, gif = gif,avg_o2 = avg_o2,avg_temp=avg_temp,uncert = uncert,archiveForecasts = archiveForecasts, parms = parms, realDrivers = realDrivers)
    write.csv(results_2015,paste("../DO_modeling_results/",date,"/forecast_2015_",model_name,"_model_",uncert,"_uncert.csv", sep = ""))
    #rmse_2015_filt <- createRmseDF_filt(n_days, results_2015, obs, cali = 14/run_space)
    #rmse_2015 <- createRmseDF(n_days, results_2015, cali = 14/run_space)
    #calcRmseTotal(n_days, results_2015, cali = 14/run_space)
    #rmse_2015
    #rmse_2015_filt
    
    #2016
    start = start_all[year(start_all)==2016]
    stop = stop_all[year(stop_all)==2016]
    results_2016 <- runForecasts(start, stop, n_days, run_space, obs, delay = 5, model_name = model_name, gif = gif,avg_o2 = avg_o2,avg_temp=avg_temp,uncert = uncert,archiveForecasts = archiveForecasts, parms = parms, realDrivers = realDrivers)
    write.csv(results_2016,paste("../DO_modeling_results/",date,"/forecast_2016_",model_name,"_model_",uncert,"_uncert.csv", sep = ""))
    #rmse_2016_filt <- createRmseDF_filt(n_days, results_2016, obs, cali = 14/run_space)
    #rmse_2016 <- createRmseDF(n_days, results_2016, cali = 14/run_space)
    #rmse_2016
    #rmse_2016_filt
    
    #2017
    start = start_all[year(start_all)==2017]
    stop = stop_all[year(stop_all)==2017]
    results_2017 <- runForecasts(start, stop, n_days, run_space, obs, delay = 30, model_name = model_name, gif = gif,avg_o2 = avg_o2,avg_temp=avg_temp,uncert = uncert,archiveForecasts = archiveForecasts, parms = parms, realDrivers = realDrivers)
    write.csv(results_2017,paste("../DO_modeling_results/",date,"/forecast_2017_",model_name,"_model_",uncert,"_uncert.csv", sep = ""))
    #rmse_2017_filt <- createRmseDF_filt(n_days, results_2017,obs, cali = 14/run_space)
    #rmse_2017 <- createRmseDF(n_days, results_2017, cali = 14/run_space)
    
    #2018
    start = start_all[year(start_all)==2018]
    stop = stop_all[year(stop_all)==2018]
    results_2018 <- runForecasts(start, stop, n_days, run_space, obs, delay = 5, model_name = model_name, gif = gif,avg_o2 = avg_o2,avg_temp=avg_temp,uncert = uncert,archiveForecasts = archiveForecasts, parms = parms, realDrivers = realDrivers)
    write.csv(results_2018,paste("../DO_modeling_results/",date,"/forecast_2018_",model_name,"_model_",uncert,"_uncert.csv", sep = ""))
    #rmse_2018_filt <- createRmseDF_filt(n_days, results_2018,obs, cali = 14/run_space)
    #rmse_2018 <- createRmseDF(n_days, results_2018, cali = 14/run_space)
    #rmse_2018
    #rmse_2018_filt
    
    #2019
    start = start_all[year(start_all)==2019]
    stop = stop_all[year(stop_all)==2019]
    results_2019 <- runForecasts(start, stop, n_days, run_space, obs, delay = 5, model_name = model_name, gif = gif,avg_o2 = avg_o2,avg_temp=avg_temp,uncert = uncert,archiveForecasts = archiveForecasts, parms = parms, realDrivers = realDrivers)
    write.csv(results_2019,paste("../DO_modeling_results/",date,"/forecast_2019_",model_name,"_model_",uncert,"_uncert.csv", sep = ""))
    #rmse_2019_filt <- createRmseDF_filt(n_days, results_2019,obs, cali = 14/run_space)
    #rmse_2019 <- createRmseDF(n_days, results_2019, cali = 14/run_space)
    #rmse_2019
    #rmse_2019_filt
  }
}

date <- "21nov20"

for(model_name in c("full","temp","o2")){ 
  results_2013 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2013_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2014 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2014_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2015 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2015_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2016 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2016_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2017 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2017_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2018 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2018_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2019 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2019_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  rmse_2013_filt <- createRmseDF_filt(n_days, results_2013, obs, cali = 14/run_space) 
  rmse_2013 <- createRmseDF(n_days, results_2013, cali = 14/run_space) # Calculate rmse for all days
  rmse_2014_filt <- createRmseDF_filt(n_days, results_2014, obs, cali = 14/run_space) 
  rmse_2014 <- createRmseDF(n_days, results_2014, cali = 14/run_space) # Calculate rmse for all days 
  rmse_2015_filt <- createRmseDF_filt(n_days, results_2015, obs, cali = 14/run_space) 
  rmse_2015 <- createRmseDF(n_days, results_2015, cali = 14/run_space) # Calculate rmse for all days
  rmse_2016_filt <- createRmseDF_filt(n_days, results_2016, obs, cali = 14/run_space) 
  rmse_2016 <- createRmseDF(n_days, results_2016, cali = 14/run_space) # Calculate rmse for all days
  rmse_2017_filt <- createRmseDF_filt(n_days, results_2017, obs, cali = 14/run_space) 
  rmse_2017 <- createRmseDF(n_days, results_2017, cali = 14/run_space) # Calculate rmse for all days
  rmse_2018_filt <- createRmseDF_filt(n_days, results_2018, obs, cali = 14/run_space) 
  rmse_2018 <- createRmseDF(n_days, results_2018, cali = 14/run_space) # Calculate rmse for all days
  rmse_2019_filt <- createRmseDF_filt(n_days, results_2019, obs, cali = 14/run_space) 
  rmse_2019 <- createRmseDF(n_days, results_2019, cali = 14/run_space) # Calculate rmse for all days
  
  
  rmse_total <- rmse_2013%>%
    mutate(Year = 2013)%>%
    full_join(rmse_2014 %>% mutate (Year = 2014))%>%
    full_join(rmse_2015 %>% mutate (Year = 2015))%>%
    full_join(rmse_2016 %>% mutate (Year = 2016))%>%
    full_join(rmse_2017 %>% mutate (Year = 2017))%>%
    full_join(rmse_2018 %>% mutate (Year = 2018))%>%
    full_join(rmse_2019 %>% mutate (Year = 2019))
  write.csv(rmse_total,paste("../DO_modeling_results/rmse_",model_name,"_",date,".csv", sep = ""))
  
  rmse_total_filt <- rmse_2013_filt%>%
    mutate(Year = 2013)%>%
    full_join(rmse_2014_filt %>% mutate (Year = 2014))%>%
    full_join(rmse_2015_filt %>% mutate (Year = 2015))%>%
    full_join(rmse_2016_filt %>% mutate (Year = 2016))%>%
    full_join(rmse_2017_filt %>% mutate (Year = 2017))%>%
    full_join(rmse_2018_filt %>% mutate (Year = 2018))%>%
    full_join(rmse_2019_filt %>% mutate (Year = 2019))
  write.csv(rmse_total_filt,paste("../DO_modeling_results/rmse_filt_",model_name,"_",date,".csv", sep = ""))
}


#My favorite params: mean(c(1.706,0.7211,1.126,1.792)) = 1.33
#Current best params: mean(c(1.73, 0.625, 1.348, 1.838)) #parms = c(0.8838931, 1.1340624, 0.1000000, 3.3282409)
```

```{r}
date = "15Sep20"
model_name = "full"
n_days = 14
run_space = 1
for(model_name in c("full")){ 
  results_2013 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2013_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2014 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2014_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2015 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2015_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2016 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2016_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2017 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2017_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2018 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2018_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  results_2019 <- read.csv(paste("../DO_modeling_results/",date,"/forecast_2019_",model_name,"_model_all_uncert.csv", sep = ""), row.names = 1)
  nmae_2013 <- createNmaeDF(n_days, results_2013, cali = 14/run_space) # Calculate rmse for all days
  nmae_2014 <- createNmaeDF(n_days, results_2014, cali = 14/run_space) # Calculate rmse for all days 
  nmae_2015 <- createNmaeDF(n_days, results_2015, cali = 14/run_space) # Calculate rmse for all days
  nmae_2016 <- createNmaeDF(n_days, results_2016, cali = 14/run_space) # Calculate rmse for all days
  nmae_2017 <- createNmaeDF(n_days, results_2017, cali = 14/run_space) # Calculate rmse for all days
  nmae_2018 <- createNmaeDF(n_days, results_2018, cali = 14/run_space) # Calculate rmse for all days
  nmae_2019 <- createNmaeDF(n_days, results_2019, cali = 14/run_space) # Calculate rmse for all days
  
  
  nmae_total <- nmae_2013%>%
    mutate(Year = 2013)%>%
    full_join(nmae_2014 %>% mutate (Year = 2014))%>%
    full_join(nmae_2015 %>% mutate (Year = 2015))%>%
    full_join(nmae_2016 %>% mutate (Year = 2016))%>%
    full_join(nmae_2017 %>% mutate (Year = 2017))%>%
    full_join(nmae_2018 %>% mutate (Year = 2018))%>%
    full_join(nmae_2019 %>% mutate (Year = 2019))
  write.csv(nmae_total,paste("../DO_modeling_results/nmae_",model_name,"_",date,".csv", sep = ""))
}
```


```{r}
temp <- read.csv("../DO_modeling_results/rmse_temp_15Sep20.csv")
o2 <- read.csv("../DO_modeling_results/rmse_o2_15Sep20.csv")
full <- read.csv("../DO_modeling_results/rmse_full_15Sep20.csv")
#sss <- read.csv("../DO_modeling_results/rmse_sss_03Jun20.csv")
persist <- read.csv("../DO_modeling_results/rmse_persist_15Sep20.csv")

rmse_all <- persist%>%
  mutate(Model = "persistance")%>%
  full_join(full %>% mutate(Model = "full"))%>%
  full_join(o2 %>% mutate(Model = "o2"))%>%
  full_join(temp %>% mutate(Model = "temp"))
  #full_join(sss %>% mutate(Model = "sss"))

date <- format(Sys.Date(),"%d%b%y")
jpeg(paste("../DO_modeling_figures/",date,"/RMSE_all.jpeg",sep = ""),width = 5, height = 3, unit = "in", res = 300)
cbbPalette <- c("#0072B2", "#009E73","#000000",  "#D55E00", "#CC79A7")
rmse_all %>%
  filter(Year!=2017)%>%
  ggplot(aes(x = n, y = val, color = Model, lty = Model))+
  geom_line()+
  ylab("RMSE (mg/L)")+
  scale_color_manual(limits = c("o2","temp","full","sss","persistance"), labels = c("oxygen only","temperature only","both","neither","persistence"), values=cbbPalette)+
  scale_linetype_manual(limits = c("o2","temp","full","sss","persistance"), labels = c("oxygen only","temperature only","both","neither","persistence"), values = c(3,4,5,2,1))+
  xlab("Days past forecast generation")+
  facet_wrap("Year")+
  theme_light()
dev.off()

rmse_all%>%
  filter(n==14,
         Year%in%c(2018,2019))
```

```{r}
#Bias figure and crps

#Just to get column names
all_model <- read.csv(paste("../DO_modeling_results/15Sep20/forecast_2013_full_model_all_uncert.csv",sep = ""))

#Run through all saved forecasts
for(year in seq(2013,2019)){
  full <- read.csv(paste("../DO_modeling_results/15Sep20/forecast_",year,"_full_model_all_uncert.csv",sep = ""))%>%
    mutate(model = "full",
           year = year)
  o2 <- read.csv(paste("../DO_modeling_results/15Sep20/forecast_",year,"_o2_model_all_uncert.csv",sep = ""))%>%
    mutate(model = "o2",
           year = year)
  #sss <- read.csv(paste("../DO_modeling_results/15Sep20/forecast_",year,"_sss_model_all_uncert.csv",sep = ""))%>%
  #  mutate(model = "sss",
  #         year = year)
  temp <- read.csv(paste("../DO_modeling_results/15Sep20/forecast_",year,"_temp_model_all_uncert.csv",sep = ""))%>%
    mutate(model = "temp",
           year = year)
  all_model = all_model%>%
    full_join(full)%>%
    full_join(o2)%>%
    full_join(temp)#%>%
    #full_join(sss)
}

toCalcBias <- all_model
years<- seq(2013,2019)
models = c("full","o2","temp")
n <- rep(seq(1,n_days),length(years)*length(models))
year <- rep(years,each = n_days, times = length(models))
model <- rep(models, each = length(years)*n_days)
output_df <- data.frame(n, year, model)
results <- as.data.frame(toCalcBias)
for(model in models){
  for(year in seq(2013,2019, by = 1)){
    for(i in seq(1:n_days)){
      predicted <- results[results$year == year & results$model == model, i+2]
      observed <-  results[results$year == year & results$model == model, i+2 + n_days]
      output_df$mean[output_df$n==i & output_df$year==year & output_df$model==model] <- mean(predicted[!is.na(observed)]-observed[!is.na(observed)])
      output_df$sd[output_df$n==i & output_df$year==year & output_df$model==model]   <- sd(predicted[!is.na(observed)]-observed[!is.na(observed)])
    }
  }
}
library(verification) #<- only load if necessary
#Adding crps
for(i in 1:n_days){
  for(j in 1:nrow(all_model)){
    if(!is.na(all_model[j,paste("PLUS",i,"_obs",sep = "")])){
        all_model[j,paste("PLUS",i,"_crps",sep = "")]<-crps(all_model[j,paste("PLUS",i,"_obs",sep = "")],c(all_model[j,paste("PLUS",i,"_pred",sep = "")],sqrt(all_model[j,paste("PLUS",i,"_var",sep = "")])))[1]
    }
  }
}
```


```{r}
png("../DO_modeling_figures/15Sep20/bias_horizon.png",width = 6, height = 4, units = "in", res = 300)
output_df%>%
  ggplot(aes(x = n, y = mean, col = model))+
  geom_line()+
  facet_wrap(~year)+
  xlab("Forecast horizon")+
  ylab("BIAS")
dev.off()
```